# 项目多语言（国际化）技术反讲文稿

> 1. 面向：质量团队（QA / 测试 / 质量工程）
>    项目：hecom-i18n-tools 在业务仓库的落地使用方案
>    日期：2025-10-22
>    版本：v1.0 初稿

---

## 1. 背景与目标

随着产品进入多市场、多区域，前端需要支持多语言（中文、英文，并计划扩展日语/韩语等）。现有业务存在：

- 中文硬编码分散在组件、页面、工具函数中，统计困难。
- 文本更新缺乏可追溯性（无法快速定位源位置）。
- 增量迭代中难区分“新增”与“已翻译”内容。
- 缺少统一的质量保障（冲突检测、占位符一致性、lint 规范）。

本项目通过 `hecom-i18n-tools` 引入标准化全链路：扫描 → Excel 管理 → 回写替换 → 语言包生成 → 冲突阻断 → 增量维护。质量团队可获得：

- 稳定 key 生成（哈希策略），降低命名主观性导致的重复/冲突。
- GitLab 源码链接直接定位翻译上下文。
- 全量与增量翻译清晰区分，测试场景可制定明确覆盖策略。
- 冲突提前阻断（不同翻译版本），保证语言包一致性与可回滚性。

---

## 2. 范围与非目标

### 本阶段覆盖：

- React / React Native / TypeScript 源码中文文本提取。
- 文本替换为 `t(key)` 调用、保留占位符结构（模板字符串 → `{{TypeN}}`）。
- 多语言 JSON 生成（zh / en 起步，可扩展）。
- 翻译生命周期规范与质量基线。
- 静态中文常量与枚举检测 (static-consts)。
- 冲突检测、增量合并策略、主 Excel 管理。

### 暂不覆盖（后续规划）：

- 服务端语言包下发与动态拉取策略。
- A/B 国际化性能基准压测。
- 运行时占位符智能类型校验（需结合 TS AST 二次增强）。
- 机器翻译自动填充（已预留接口）。

---

## 3. 总体架构

```
┌────────────────────┐    扫描(scan)       ┌────────────────────┐
│ 业务源码 (JS/TS/JSX)│  ───────────────▶  │ 扫描结果 Excel      │
└────────────────────┘                    │(key, zh, file, line)│
        ▲   │ 回写(replace)                └────────────────────┘
        │   │                                   │ 生成(gen)
        │   └───────────────◀───────────────────┘
        │                                           │
        │                                   ┌──────────────────┐
        │                                   │ 多语言 JSON 包    │
        │                                   │ zh-CN.json, en-US │
        │                                   └──────────────────┘
        │                                            │
        │                                        引入运行时
        │                                            ▼
                                       ┌────────────────────────┐
                                       │  t(key, params) 渲染层 │
                                       └────────────────────────┘
```

核心组件：

- scanner.ts：AST + 规则（忽略 testID / ignore 注释 / 日志对象）→ 提取中文。
- replacer.ts：基于 Excel 回写源代码（安全跳过类型定义、StyleSheet、日志等）。
- i18nGenerator.ts：冲突检测（同 key 不同翻译）→ 阻断写入并生成冲突报告。
- staticConstsScanner.ts：全局 const / enum 中的中文集合，用于评估是否需惰性翻译策略。
- cli.ts：统一 CLI 命令入口。

---

## 4. 关键流程分解

### 4.1 扫描阶段（scan）

输入：源码路径、GitLab 前缀、配置文件。
规则：

- 支持多路径 `src,a,b`。
- 忽略：`i18n-ignore-file`、行级 `// i18n-ignore`、测试属性 (testID / accessibilityLabel / nativeID 等)。
- 忽略日志：`console.*`、`UnionLog.*` + 可配置追加 (`ignoreLogObjects`, `ignoreLogMethods`)。
- 模板字符串参数归一：如 ``你好，${name}！今天是 ${day}`` → `你好，{{Identifier1}}！今天是 {{Identifier2}}`。
- 生成 key：`i18n_` + md5(文本).substring(0,12)。可通过 config 自定义稳定 hash。
  产出：Excel（支持多 sheet，行含：key, zh, file, line, gitlab）。

### 4.2 翻译管理（Excel）

质量要点：

- 每行可追踪上下文（文件+行号+GitLab URL）。
- 新增语言列（ja / ko）不影响已生成的 JSON。
- 主表合并策略：追加模式，不去重，测试需关注重复行潜在风险。

### 4.3 回写阶段（replace）

行为：

- 读取所有 sheet，按 file 分组 → 逐文件处理。
- 跳过：类型注解、函数返回类型、StyleSheet.create 内字面量、日志调用、忽略注释指示区域。
- 替换：
  - 普通字符串 → `{t('i18n_xxx')}` / 属性值 → `title={t('i18n_xxx')}`。
  - 模板字符串 → 保留占位标识，后续运行时参数映射。
- 保留文件结构行距（降低 diff 噪音）。
  风险控制：
- Excel 未包含目标文件条目 → 跳过，避免误破坏。
- 未找到中文文本匹配 → 不做 AST 解析深改（性能优化）。

### 4.4 语言包生成（gen）

特性：

- 先冲突预检：旧 JSON 中同 key 不同值 → 生成 `conflicts-*.json`，阻断写入（构建失败提醒）。
- 无冲突：旧值保留，新值增补/覆盖 → 最终合并写入。
- 可选主表合并：合并完成后删除源 Excel（保持单一来源）。

### 4.5 静态常量分析（static-consts）

用途：

- 识别顶层可重用中文集合（例如星期数组），建议使用 `t(key)` 或延迟翻译函数包装，避免运行时语言切换不生效。
- 输出 CSV 或控制台报告：便于测试枚举边界值。

---

## 5. 数据与文件规范

| 维度             | 说明     | 质量关注点                                  |
| ---------------- | -------- | ------------------------------------------- |
| key              | 稳定哈希 | 一致性，不携带语义避免误解测试用途          |
| zh               | 原文     | 不允许含调试信息/临时占位符                 |
| en/ja…          | 译文     | 空值策略：回退 zh；测试需覆盖 fallback 行为 |
| gitlab           | 链接     | 回归定位、变更审计                          |
| line             | 行号     | 与实际差异较大需标记（极少数 AST 调整）     |
| conflicts-*.json | 冲突报告 | 归档与根因分析                              |

占位符规范：

- 生成阶段模板：`{{Identifier1}}`、`{{BinaryExpression1}}` 等。
- 运行时替换：调用 `t(key,{Identifier1: value})`。
- 测试关注：占位符数一致性 → 若翻译缺失占位符需拦截。

---

## 6. 运行时调用策略（建议）

最小接口：

```ts
function t(key: string, params?: Record<string, any>): string
```

运行时顺序：当前语言 → zh-CN → 原 key（降级）。
质量团队建议增加：

1. `strictMode`：若翻译缺少占位符，返回错误日志并上报。
2. `traceMissingKeys`：收集未翻译 key，便于回归测试。
3. `mockLocale`：测试环境强制切换多语言组合。

---

## 7. 质量保障策略

### 7.1 静态与流程控制

- 冲突阻断：生成阶段硬性中止，保证不出现双版本翻译。
- 忽略机制：防止测试 ID / 枚举 / 样式 / 日志被错误替换。
- 主表合并：追加模式，测试需核查重复行+是否误删。

### 7.2 自动化测试建议

| 测试类型 | 示例用例           | 断言点                          |
| -------- | ------------------ | ------------------------------- |
| 单元测试 | `t()` fallback   | 缺失 en 时返回 zh-CN            |
| 单元测试 | 模板占位符替换     | 多参数均正确替换，无残留 `{{` |
| 集成测试 | 页面加载不同语言   | UI 文案全部变更，无硬编码残留   |
| 回归测试 | 冲突场景构造       | 生成阶段报错 + 输出报告文件     |
| 扫描测试 | ignore 注释        | 标记行文本不进入 Excel          |
| 替换测试 | 日志常量           | console.log("中文") 未被替换    |
| 枚举测试 | static consts 数组 | 运行时切换语言策略是否符合预期  |

### 7.3 人工校验清单

- [ ] Excel 中是否存在空 zh / 不合法字符。
- [ ] 是否出现大量重复 key 对应相同文本（潜在复用提升点）。
- [ ] 模板类文本翻译是否保留占位符。
- [ ] en 是否存在机器翻译痕迹需要二次润色。

---

## 8. 风险与缓解

| 风险           | 场景                         | 缓解措施                                  |
| -------------- | ---------------------------- | ----------------------------------------- |
| 误替换代码结构 | 字符串在类型定义中被替换     | replacer 跳过 TS 类型 & StyleSheet.create |
| 冲突覆盖旧翻译 | 多人并行修改同 key           | 冲突阻断 + 报告归档 + 强制评审流程        |
| 大文本超长     | 超过 Excel 行支持长度        | scanner 超长警告并跳过                    |
| 占位符错漏     | 翻译遗漏 `{{Identifier1}}` | 运行时校验（规划）+ QA 模板用例           |
| 多语言不一致   | 关键按钮翻译偏差             | 关键路径术语表 + QA 语义审校              |
| 重复扫描噪音   | 临时代码 / debug 注释        | ignore 注释策略 + CI 检查                 |

---

## 9. CI/CD 集成建议

阶段化：

1. `i18n:scan`（提示新增中文，非阻断）。
2. `i18n:replace`（仅在合并前或发布前执行）。
3. `i18n:gen`（阻断：若冲突则 pipeline fail）。
4. JSON 产物入制品（artifact）并用于构建包。
5. 发布后采集 `missingKey` 日志 → 回流翻译迭代。

示例（伪 YAML 片段）：

```yaml
steps:
  - run: npm run i18n:scan
  - run: npm run i18n:gen
    continue-on-error: false
  - run: npm test -- --selectProjects=i18n
  - artifacts: 
      paths:
        - src/locales/*.json
```

---

## 10. 监控与度量指标

| 指标                  | 说明                      | 来源                 |
| --------------------- | ------------------------- | -------------------- |
| missing_keys_count    | 运行时未命中翻译的 key 数 | t() 日志聚合         |
| duplicated_zh_ratio   | zh 列重复率               | Excel 分析脚本       |
| conflict_events       | 冲突报告次数              | 生成阶段输出文件计数 |
| new_keys_per_release  | 每次发布新增 key 数       | 主表 diff            |
| untranslated_rate(en) | en 空值占比               | Excel 统计           |

---

## 11. 命名与内容规范

- key：机器生成，禁止人工改写，避免语义耦合。
- 中文：需完整句式，不写碎片（有助于上下文化翻译）。
- 模板：`${var}` → 占位符位于语义稳定位置，不分裂句子。
- 避免：含业务私有缩写未在术语库登记。

---

## 12. 回滚策略

场景：生成语言包后出现错误翻译。

1. 使用上一次构建产物中的 JSON（制品库回滚）。
2. 或恢复主 Excel 历史版本重新生成。
3. 冲突报告保留 → 支持定位交叉修改来源。

---

## 13. 性能与扩展性说明

- AST 解析按需：文件无匹配文本时跳过深解析。
- 多路径扫描支持并行拆分（未来可并发优化）。
- key 哈希长度 12：碰撞概率低，可支持十万级文本规模。
- JSON 合并 O(n)；冲突预检只读取存在旧文件的语言包。

---

## 14. 渐进式语言扩展

新增语言流程：

1. Excel 添加列（如 ja）。
2. 生成语言包后产生 `ja-JP.json`。
3. 运行时 `messages` 合并：再测试 fallback 链路。
4. QA 增补：日期/货币格式、复数形式处理（后续增强）。

---

## 15. 与质量团队协作接口

| 行为       | 责任人    | 交付物                    |
| ---------- | --------- | ------------------------- |
| 初次扫描   | 开发      | scan-result.xlsx          |
| 翻译填充   | 翻译/QA   | 完整多语言列 Excel        |
| 冲突处理   | 开发 + QA | conflicts-*.json 分析记录 |
| 语言包验收 | QA        | 用例通过 + 关键路径截图   |
| 回归跟踪   | QA        | 缺失 key / 错误翻译 issue |

---

## 16. 验收标准（生产就绪）

- ✅ 关键路径（登录 / 下单 / 设置）多语言对齐。
- ✅ 冲突检测 0 次或全部已闭环处理。
- ✅ missing key 日志 < 5（首轮上线阈值）。
- ✅ en/zh 占位符一致性 100%。
- ✅ 测试用例覆盖率：国际化相关逻辑 ≥ 80%。
- ✅ 文案术语表建立（不少于 50 条核心词条）。

---

## 17. 推进里程碑

| 阶段 | 时间 | 目标                           |
| ---- | ---- | ------------------------------ |
| 准备 | W1   | 接入工具 & 初次扫描完成        |
| 翻译 | W2   | Excel 全量翻译（zh→en）       |
| 替换 | W3   | 回写代码 + 生成语言包          |
| 测试 | W4   | 多语言功能 / 回归 / 边界       |
| 上线 | W5   | 灰度发布 & 监控指标采集        |
| 优化 | W6   | 处理 missing / 重复 / 语义修订 |

---

## 18. 后续优化方向（Roadmap）

1. 自动翻译 API 集成（加速新增文案初稿）。
2. 运行时占位符强校验（校验参数缺失 / 类型不匹配）。
3. JSON 分片按模块 lazy load（性能优化）。
4. 翻译工作台 Web 化（替代 Excel）。
5. 文案变更差异自动通知 QA（Git hook）。
6. 多语言 UI 视觉自动对比截图（OCR + 视觉回归）。

---

## 19. 附录：关键文件速览

- `src/scanner.ts`：提取规则与忽略策略实现。
- `src/replacer.ts`：AST 回写与安全跳过场景（类型、StyleSheet、日志等）。
- `src/i18nGenerator.ts`：冲突阻断 + 主表合并逻辑。
- `src/staticConstsScanner.ts`：全局常量枚举分析。
- `cli.ts`：命令注册（scan / replace / gen / static-consts）。

---

## 20. QA 建议用例示例（附录）

```jsx
// 模板替换正确性
const msg = t('i18n_xxx', { Identifier1: userName, Identifier2: day })
// 断言：渲染后文本不含 {{Identifier1}}

// 缺失翻译 fallback
setLocale('en-US');
expect(t('i18n_key_without_en')).toBe(t('i18n_key_without_en', undefined) /* fallback zh or key */);

// 冲突阻断模拟
// 预置旧 zh-CN.json 与 Excel 中同 key 不同 zh → gen 命令需报错
```

---

**结束语**：通过本套工具链与规范，国际化不再是一次性重构，而成为可持续、可审计、可迭代的持续工程。质量团队可围绕“冲突零容忍 / 占位符一致 / 缺失快速回补”三大原则建立测试与监控闭环。欢迎提出补充需求，共同完善。
